<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CoachBot</title>
<style>
  :root{--bg:#f8f9fa;--fg:#202124;--muted:#5f6368;--card:#fff;--line:#e0e0e0;--blue:#1a73e8;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:820px;margin:0 auto;padding:32px 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .brand{font-size:20px;font-weight:600}
  .muted{color:var(--muted)}
  button{border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn{background:var(--blue);color:#fff}
  .btn.alt{background:#5f6368;color:#fff}
  .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--fg)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:16px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,textarea,input{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; color:var(--fg)}
  textarea{min-height:110px; resize:vertical}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--muted)}
  .chat{display:flex;flex-direction:column;gap:10px;max-height:52vh;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
  .msg{display:flex;gap:10px}
  .right{justify-content:flex-end}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.user{background:#10b981} /* vert */
  .dot.ai{background:#ef4444}   /* rouge */
  .bubble{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:12px;padding:10px;max-width:85%}
  .hint{font-size:12px;color:var(--muted)}
  .footer{margin-top:16px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
  .hidden{display:none}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px}
  .modal>.card{max-width:420px;width:100%}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .tabs{display:flex;gap:6px;margin-bottom:8px}
  .tab{flex:1;text-align:center;border:1px solid var(--line);padding:8px;border-radius:8px;cursor:pointer;background:#fff}
  .tab.active{background:#e8f0fe;border-color:#d2e3fc}
  .row{display:flex;gap:8px;align-items:center}
  .pwd{position:relative}
  .toggle-eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--muted);font-size:13px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#202124;color:#fff;padding:10px 14px;border-radius:8px;font-size:14px;box-shadow:0 2px 12px rgba(0,0,0,.25)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">CoachBot</div>
    <div class="row" style="gap:8px">
      <div id="who" class="muted">Non connect√©</div>
      <button id="openAuth" class="btn alt">Connexion</button>
      <button id="logout" class="btn alt hidden">D√©connexion</button>
      <button id="adminBtn" class="btn ghost hidden">Admin</button>
    </div>
  </header>

  <div class="card" style="margin-bottom:12px">
    <div class="toolbar">
      <select id="day">
        <option value="1">Jour 1</option><option value="2">Jour 2</option><option value="3">Jour 3</option>
        <option value="4">Jour 4</option><option value="5">Jour 5</option><option value="6">Jour 6</option>
        <option value="7">Jour 7</option><option value="8">Jour 8</option><option value="9">Jour 9</option>
        <option value="10">Jour 10</option><option value="11">Jour 11</option><option value="12">Jour 12</option>
        <option value="13">Jour 13</option><option value="14">Jour 14</option><option value="15">Jour 15</option>
      </select>
      <div class="pill muted" id="plan">S√©lectionne un jour.</div>
      <div class="pill">Fournisseur : Claude</div>
    </div>
  </div>

  <div class="card">
    <div class="chat" id="chat"></div>
    <div class="hint" style="margin-top:8px">Point <b>vert</b> = toi ‚Ä¢ Point <b>rouge</b> = coach</div>
    <div class="row" style="margin-top:10px; gap:8px">
      <textarea id="msg" placeholder="√âcris ton message au coach‚Ä¶"></textarea>
      <button id="send" class="btn">Envoyer</button>
    </div>
    <div class="footer"><span id="status">Pr√™t</span><span id="meta">‚Äî</span></div>
  </div>
</div>

<!-- Auth Modal -->
<div id="authModal" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" id="authCard">
    <div class="modal-header">
      <strong>Connexion</strong>
      <button id="closeAuth" class="btn ghost">Fermer</button>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabUser">Utilisateur</div>
      <div class="tab" id="tabAdmin">Admin</div>
    </div>

    <div class="col" style="gap:10px">
      <input id="email" placeholder="Email" type="email" autocomplete="username" />
      <div class="pwd">
        <input id="password" placeholder="Mot de passe" type="password" autocomplete="current-password" />
        <span id="togglePwd" class="toggle-eye" title="Afficher/masquer">üëÅÔ∏è</span>
      </div>
      <input id="name" placeholder="Pr√©nom (pour inscription)" />
      <div class="row" style="gap:8px">
        <button id="doLogin" class="btn" style="flex:1">Connexion</button>
        <button id="doRegister" class="btn alt" style="flex:1">Inscription</button>
      </div>
      <div id="authErr" class="hint" style="color:#d93025;min-height:16px"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<script>
/* ---------- Elements ---------- */
const $ = s=>document.querySelector(s);
const chatEl=$("#chat"), msgEl=$("#msg"), dayEl=$("#day");
const statusEl=$("#status"), planEl=$("#plan"), metaEl=$("#meta");
const whoEl=$("#who"), openAuth=$("#openAuth"), logoutBtn=$("#logout"), adminBtn=$("#adminBtn");
const authModal=$("#authModal"), authCard=$("#authCard"), authErr=$("#authErr"), nameEl=$("#name");
const doLogin=$("#doLogin"), doRegister=$("#doRegister");
const tabUser=$("#tabUser"), tabAdmin=$("#tabAdmin");
const toastEl=$("#toast");

/* ---------- Plans ---------- */
const PLANS={1:"Clarification des intentions : d√©fi prioritaire, pourquoi c‚Äôest important, d√©finition du succ√®s.",
2:"Diagnostic : 3 leviers + 3 obstacles.",3:"Vision + 3 indicateurs mesurables.",
4:"Valeurs et motivations : alignement.",5:"√ânergie : estime de soi / amour propre / confiance.",
6:"Confiance (suite) : preuves, retours, micro‚Äëvictoires.",7:"Bilan KISS (Keep / Improve / Start / Stop).",
8:"Nouveau d√©part : cap + 48h.",9:"Plan simple : 1 action cl√© / jour.",10:"CNV : pr√©parer un message cl√©.",
11:"D√©cisions : Stop / Keep / Start.",12:"√âchelle de responsabilit√©.",13:"Co‚Äëd√©veloppement √©clair.",
14:"Leadership (Maxwell).",15:"Bilan + plan 30 jours."};

/* ---------- Storage / API ---------- */
function token(){return localStorage.getItem("coachbot.token")||null}
function setToken(t){t?localStorage.setItem("coachbot.token",t):localStorage.removeItem("coachbot.token")}
async function api(path,opt={}){const h=Object.assign({"Content-Type":"application/json"},opt.headers||{});const t=token();if(t)h.Authorization="Bearer "+t;return fetch(path,Object.assign({},opt,{headers:h}))}

/* ---------- UI helpers ---------- */
function addMsg(role,text){
  const row=document.createElement("div");row.className="msg "+(role==="user"?"right":"");
  row.innerHTML=`<div class="dot ${role==="user"?"user":"ai"}"></div><div class="bubble"></div>`;
  row.querySelector(".bubble").textContent=text; chatEl.appendChild(row); chatEl.scrollTop=chatEl.scrollHeight;
}
function setPlan(){planEl.textContent=PLANS[Number(dayEl.value||1)]||"‚Äî"}
function show(el){el.classList.remove("hidden")} function hide(el){el.classList.add("hidden")}
function toast(txt){toastEl.textContent=txt;show(toastEl);setTimeout(()=>hide(toastEl),1600)}

/* ---------- Auth modal ---------- */
let authMode="user"; // "user" | "admin"
function selectMode(mode){
  authMode=mode;
  tabUser.classList.toggle("active",mode==="user");
  tabAdmin.classList.toggle("active",mode==="admin");
}
tabUser.onclick=()=>selectMode("user");
tabAdmin.onclick=()=>selectMode("admin");

openAuth.onclick=()=>{show(authModal);authErr.textContent="";$("#email").focus()}
$("#closeAuth").onclick=()=>hide(authModal);

// fermer au clic hors carte
authModal.addEventListener("click",(e)=>{ if(e.target===authModal) hide(authModal); });
// emp√™cher la propagation dans la carte
authCard.addEventListener("click",(e)=>e.stopPropagation());
// fermer avec √âchap
window.addEventListener("keydown",(e)=>{ if(!authModal.classList.contains("hidden") && e.key==="Escape") hide(authModal); });

// ≈ìil mot de passe
$("#togglePwd").onclick=()=>{
  const p=$("#password"); p.type = p.type==="password" ? "text" : "password";
};

// Entr√©e = bouton Connexion
authModal.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){ doLogin.click(); }
});

/* ---------- Auth UI header ---------- */
function updateAuthUI(user){
  if(user){
    whoEl.textContent=`Connect√© : ${user.name||user.email}`;
    hide(openAuth); show(logoutBtn);
    if(user.role==="admin"){ show(adminBtn); } else { hide(adminBtn); }
  }else{
    whoEl.textContent="Non connect√©"; show(openAuth); hide(logoutBtn); hide(adminBtn);
  }
}
logoutBtn.onclick=()=>{ setToken(null); updateAuthUI(null); chatEl.innerHTML=""; statusEl.textContent="D√©connect√©"; toast("D√©connect√©"); };

/* ---------- Auth calls ---------- */
async function doLoginCall(){
  authErr.textContent=""; statusEl.textContent="Connexion‚Ä¶";
  const email=$("#email").value.trim(), password=$("#password").value.trim();
  if(!email||!password){authErr.textContent="Email et mot de passe requis.";return}
  try{
    const r=await api("/api/auth/login",{method:"POST",body:JSON.stringify({email,password})});
    const d=await r.json().catch(()=>null);
    if(!r.ok || !d){authErr.textContent=(d&&d.error)||"Erreur connexion";return}

    // Si onglet Admin, v√©rifier le r√¥le
    if(authMode==="admin" && d.user?.role!=="admin"){
      authErr.textContent="Ce compte n‚Äôest pas admin."; return;
    }

    setToken(d.token); updateAuthUI(d.user);
    hide(authModal); toast("‚úÖ Connexion r√©ussie"); statusEl.textContent="Connect√©";
    await hydrate();
  }catch{authErr.textContent="Erreur r√©seau"}
}
async function doRegisterCall(){
  authErr.textContent=""; statusEl.textContent="Inscription‚Ä¶";
  const email=$("#email").value.trim(), password=$("#password").value.trim(), name=(nameEl.value||"").trim()||null;
  if(!email||!password){authErr.textContent="Email et mot de passe requis.";return}
  try{
    const r=await api("/api/auth/register",{method:"POST",body:JSON.stringify({email,password,name})});
    const d=await r.json().catch(()=>null);
    if(!r.ok || !d){authErr.textContent=(d&&d.error)||"Erreur inscription";return}
    setToken(d.token); updateAuthUI(d.user);
    hide(authModal); toast("‚úÖ Inscrit et connect√©"); statusEl.textContent="Connect√©";
    await hydrate();
  }catch{authErr.textContent="Erreur r√©seau"}
}
doLogin.onclick=doLoginCall; doRegister.onclick=doRegisterCall;

// bouton Admin ‚Üí /admin (n‚Äôapparait que si role admin)
adminBtn.onclick=()=>{ location.href="/admin"; };

/* ---------- Me + Journal ---------- */
async function hydrate(){
  if(!token()){updateAuthUI(null);return}
  try{
    const me=await api("/api/me");
    if(!me.ok){setToken(null);updateAuthUI(null);return}
    const {user,meta}=await me.json();
    updateAuthUI(user);
    metaEl.textContent=`Pr√©nom: ${meta?.name||"‚Äî"} ‚Ä¢ DISC: ${meta?.disc||"‚Äî"}`;
    await loadJournal();
  }catch{}
}
async function loadJournal(){
  chatEl.innerHTML=""; const d=Number(dayEl.value||1);
  try{
    const r=await api(`/api/journal?day=${d}`);
    if(!r.ok){addMsg("ai","Connecte‚Äëtoi pour voir le journal.");return}
    const arr=await r.json(); if(Array.isArray(arr)){for(const m of arr){addMsg(m.role,m.message)}}
  }catch{addMsg("ai","Erreur de chargement du journal.")}
}

/* ---------- Chat (SSE Claude) ---------- */
$("#send").onclick=async ()=>{
  const t=msgEl.value.trim(); if(!t) return;
  if(!token()){show(authModal);return}
  const d=Number(dayEl.value||1);
  addMsg("user",t); msgEl.value=""; statusEl.textContent="R√©ponse en cours‚Ä¶";
  try{
    const r=await fetch("/api/chat/stream",{method:"POST",headers:{
      "Content-Type":"application/json","Authorization":"Bearer "+token()
    },body:JSON.stringify({message:t,day:d,provider:"anthropic"})});
    if(!r.ok){addMsg("ai","Erreur serveur (chat).");statusEl.textContent="Erreur.";return}
    const reader=r.body.getReader(); const dec=new TextDecoder(); let buf="",acc=""; let bubble=null;
    function appendDelta(s){if(!bubble){const row=document.createElement("div");row.className="msg";row.innerHTML=`<div class="dot ai"></div><div class="bubble"></div>`;chatEl.appendChild(row);bubble=row.querySelector(".bubble");}
      acc+=s; bubble.textContent=acc; chatEl.scrollTop=chatEl.scrollHeight;}
    while(true){const {done,value}=await reader.read(); if(done)break;
      buf+=dec.decode(value,{stream:true}); const lines=buf.split("\n"); buf=lines.pop();
      for(const ln of lines){if(!ln.startsWith("data:"))continue; const payload=ln.slice(5).trim(); if(payload==="[DONE]")continue;
        try{const obj=JSON.parse(payload); if(obj.text)appendDelta(obj.text); if(obj.error)appendDelta("\n[Erreur] "+obj.error);}catch{}}}
    statusEl.textContent="Pr√™t";
  }catch{addMsg("ai","Erreur r√©seau.");statusEl.textContent="Erreur r√©seau";}
};

/* ---------- Init ---------- */
dayEl.onchange=()=>{setPlan();loadJournal();}
setPlan(); hydrate();
</script>
</body>
</html>
