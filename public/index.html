<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CoachBot</title>
<style>
  :root{
    --bg:#f8f9fa;--fg:#202124;--muted:#5f6368;--card:#fff;--line:#e0e0e0;--blue:#1a73e8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:820px;margin:0 auto;padding:32px 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .brand{font-size:20px;font-weight:600}
  .muted{color:var(--muted)}
  button{border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn{background:var(--blue);color:#fff}
  .btn.alt{background:#5f6368}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:16px}
  .row{display:flex;gap:12px;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  .grid{display:grid;gap:12px}
  .grid.two{grid-template-columns:1fr 1fr}
  input,select,textarea{
    width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; color:var(--fg);
  }
  textarea{min-height:110px; resize:vertical}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}
  .chat{display:flex;flex-direction:column;gap:10px;max-height:52vh;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
  .msg{display:flex;gap:10px}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.user{background:#10b981}   /* vert user */
  .dot.ai{background:#ef4444}     /* rouge coach */
  .bubble{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:12px;padding:10px;max-width:85%}
  .right{justify-content:flex-end}
  .center{display:flex;justify-content:center;color:var(--muted);font-size:12px}
  .hint{font-size:12px;color:var(--muted)}
  .footer{margin-top:16px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
  .hidden{display:none}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px}
  .modal>.card{max-width:420px;width:100%}
  .link{color:var(--blue);cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">CoachBot</div>
    <div class="row">
      <div id="who" class="muted">Non connecté</div>
      <button id="openAuth" class="btn alt">Connexion / Inscription</button>
      <button id="logout" class="btn alt hidden">Déconnexion</button>
      <button id="adminBtn" class="btn alt" onclick="location.href='/admin'">Admin</button>
    </div>
  </header>

  <div class="card" style="margin-bottom:12px">
    <div class="toolbar">
      <select id="day">
        <option value="1">Jour 1</option><option value="2">Jour 2</option><option value="3">Jour 3</option>
        <option value="4">Jour 4</option><option value="5">Jour 5</option><option value="6">Jour 6</option>
        <option value="7">Jour 7</option><option value="8">Jour 8</option><option value="9">Jour 9</option>
        <option value="10">Jour 10</option><option value="11">Jour 11</option><option value="12">Jour 12</option>
        <option value="13">Jour 13</option><option value="14">Jour 14</option><option value="15">Jour 15</option>
      </select>
      <div class="pill muted" id="plan">Sélectionne un jour.</div>
      <div class="pill">Fournisseur: Claude</div>
    </div>
  </div>

  <div class="grid" style="grid-template-columns:1fr">
    <div class="card">
      <div class="chat" id="chat"></div>
      <div class="hint" style="margin-top:8px">Point <b class="muted">vert</b> = toi • Point <b class="muted">rouge</b> = coach</div>
      <div class="row" style="margin-top:10px; gap:8px">
        <textarea id="msg" placeholder="Écris ton message au coach… (réponses courtes et concrètes)"></textarea>
        <button id="send" class="btn">Envoyer</button>
      </div>
      <div class="footer"><span id="status">Prêt</span><span id="meta">—</span></div>
    </div>
  </div>
</div>

<!-- Auth Modal -->
<div id="authModal" class="modal hidden">
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <strong id="authTitle">Connexion</strong>
      <span id="closeAuth" class="link">Fermer</span>
    </div>
    <div class="col" style="margin-top:8px">
      <input id="email" placeholder="Email" type="email" />
      <input id="password" placeholder="Mot de passe" type="password" />
      <input id="name" placeholder="Prénom (inscription)" class="" />
      <button id="doLogin" class="btn">Connexion</button>
      <button id="doRegister" class="btn alt">Inscription</button>
      <div class="hint">Besoin d’un compte ? Clique sur “Inscription”.</div>
      <div id="authErr" class="hint" style="color:#d93025"></div>
    </div>
  </div>
</div>

<script>
/* --------------- Helpers --------------- */
const $ = (s)=>document.querySelector(s);
const chatEl = $("#chat"), msgEl = $("#msg"), dayEl = $("#day");
const statusEl = $("#status"), planEl = $("#plan"), metaEl = $("#meta");
const whoEl = $("#who"), openAuth = $("#openAuth"), logoutBtn = $("#logout");
const authModal = $("#authModal"), authErr = $("#authErr"), nameEl = $("#name");
const doLogin = $("#doLogin"), doRegister = $("#doRegister");

const PLANS = {
  1:"Clarification des intentions : défi prioritaire, pourquoi c’est important, définition du succès.",
  2:"Diagnostic : 3 leviers + 3 obstacles.",
  3:"Vision + 3 indicateurs mesurables.",
  4:"Valeurs et motivations : alignement.",
  5:"Énergie : estime de soi / amour propre / confiance.",
  6:"Confiance (suite) : preuves, retours, micro‑victoires.",
  7:"Bilan KISS (Keep / Improve / Start / Stop).",
  8:"Nouveau départ : cap + 48h.",
  9:"Plan simple : 1 action clé / jour.",
  10:"CNV : préparer un message clé.",
  11:"Décisions : Stop / Keep / Start.",
  12:"Échelle de responsabilité.",
  13:"Co‑développement éclair.",
  14:"Leadership (Maxwell).",
  15:"Bilan + plan 30 jours."
};

function token(){ return localStorage.getItem("coachbot.token")||null; }
function setToken(t){ if(t) localStorage.setItem("coachbot.token", t); else localStorage.removeItem("coachbot.token"); }
async function api(path, opts={}) {
  const headers = Object.assign({ "Content-Type":"application/json" }, opts.headers||{});
  const t = token(); if(t) headers.Authorization = "Bearer "+t;
  const r = await fetch(path, Object.assign({},opts,{headers}));
  return r;
}
function addMsg(role, text){
  const row = document.createElement("div");
  row.className = "msg " + (role==="user" ? "right" : "");
  row.innerHTML = `
    <div class="dot ${role==="user"?"user":"ai"}"></div>
    <div class="bubble">${text.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>`;
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}
function setPlan(){
  const d = Number(dayEl.value||1);
  planEl.textContent = PLANS[d] || "—";
}

/* --------------- Auth UI --------------- */
function updateAuthUI(u){
  if(u){
    whoEl.textContent = `Connecté : ${u.name||u.email}`;
    openAuth.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
  } else {
    whoEl.textContent = "Non connecté";
    openAuth.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
  }
}

function showAuth(){ authModal.classList.remove("hidden"); }
function hideAuth(){ authModal.classList.add("hidden"); authErr.textContent=""; }

openAuth.onclick = showAuth;
$("#closeAuth").onclick = hideAuth;
logoutBtn.onclick = ()=>{ setToken(null); updateAuthUI(null); chatEl.innerHTML=""; statusEl.textContent="Déconnecté"; };

/* --------------- Auth calls --------------- */
doLogin.onclick = async ()=>{
  authErr.textContent=""; statusEl.textContent="Connexion…";
  const email=$("#email").value.trim(), password=$("#password").value.trim();
  if(!email||!password){ authErr.textContent="Email et mot de passe requis."; return; }
  try{
    const r = await api("/api/auth/login",{ method:"POST", body:JSON.stringify({ email, password }) });
    const d = await r.json();
    if(!r.ok){ authErr.textContent=d.error||"Erreur connexion"; return; }
    setToken(d.token); updateAuthUI(d.user); hideAuth(); statusEl.textContent="Connecté";
    await hydrate();
  }catch{ authErr.textContent="Erreur réseau"; }
};
doRegister.onclick = async ()=>{
  authErr.textContent=""; statusEl.textContent="Inscription…";
  const email=$("#email").value.trim(), password=$("#password").value.trim(), name=nameEl.value.trim()||null;
  if(!email||!password){ authErr.textContent="Email et mot de passe requis."; return; }
  try{
    const r = await api("/api/auth/register",{ method:"POST", body:JSON.stringify({ email, password, name }) });
    const d = await r.json();
    if(!r.ok){ authErr.textContent=d.error||"Erreur inscription"; return; }
    setToken(d.token); updateAuthUI(d.user); hideAuth(); statusEl.textContent="Inscrit et connecté";
    await hydrate();
  }catch{ authErr.textContent="Erreur réseau"; }
};

/* --------------- Me + Journal --------------- */
async function hydrate(){
  if(!token()){ updateAuthUI(null); return; }
  try{
    const me = await api("/api/me");
    if(!me.ok){ setToken(null); updateAuthUI(null); return; }
    const { user, meta } = await me.json();
    updateAuthUI(user);
    metaEl.textContent = `Prénom: ${meta?.name||"—"} • DISC: ${meta?.disc||"—"}`;
    await loadJournal();
  }catch{ /* ignore */ }
}
async function loadJournal(){
  chatEl.innerHTML = "";
  const d = Number(dayEl.value||1);
  try{
    const r = await api(`/api/journal?day=${d}`);
    if(!r.ok){ addMsg("ai","Connecte-toi pour voir le journal."); return; }
    const arr = await r.json();
    if(Array.isArray(arr)){
      for(const m of arr){
        addMsg(m.role, m.message);
      }
    }
  }catch{
    addMsg("ai","Erreur de chargement du journal.");
  }
}

/* --------------- Send / Stream --------------- */
$("#send").onclick = async ()=>{
  const t = msgEl.value.trim();
  if(!t) return;
  if(!token()){ showAuth(); return; }
  const d = Number(dayEl.value||1);
  addMsg("user", t);
  msgEl.value="";
  statusEl.textContent="Réponse en cours…";

  // Streaming SSE (Claude)
  try{
    const r = await fetch("/api/chat/stream",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization": "Bearer "+token()
      },
      body: JSON.stringify({ message:t, day:d, provider:"anthropic" })
    });
    if(!r.ok){ addMsg("ai","Erreur serveur (chat)."); statusEl.textContent="Erreur serveur"; return; }
    const reader = r.body.getReader();
    const decoder = new TextDecoder();
    let buffer="", acc="";
    let currentBubble = null;

    function appendDelta(delta){
      if(!currentBubble){
        const row = document.createElement("div");
        row.className = "msg";
        row.innerHTML = `<div class="dot ai"></div><div class="bubble"></div>`;
        chatEl.appendChild(row);
        currentBubble = row.querySelector(".bubble");
      }
      acc += delta;
      currentBubble.textContent = acc;
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      buffer += decoder.decode(value,{stream:true});
      const lines = buffer.split("\n");
      buffer = lines.pop();
      for(const line of lines){
        if(!line.startsWith("data:")) continue;
        const payload = line.slice(5).trim();
        if(payload==="[DONE]") continue;
        try{
          const obj = JSON.parse(payload);
          if(obj.text){ appendDelta(obj.text); }
          if(obj.error){ appendDelta("\n[Erreur] "+obj.error); }
        }catch{}
      }
    }
    statusEl.textContent="Prêt";
  }catch{
    addMsg("ai","Erreur réseau.");
    statusEl.textContent="Erreur réseau";
  }
};

/* --------------- Init --------------- */
dayEl.onchange = ()=>{ setPlan(); loadJournal(); };
setPlan();
hydrate();
</script>
</body>
</html>
